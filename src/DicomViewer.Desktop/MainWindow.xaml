<Window x:Class="DicomViewer.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:DicomViewer.Desktop.ViewModels"
        Title="DICOM ROI Analyzer" Height="800" Width="1200"
        WindowStartupLocation="CenterScreen"
        Icon="app.ico">
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>
    <Window.InputBindings>
        <KeyBinding Key="Z" Modifiers="Ctrl"
                    Command="{Binding UndoRoiCommand}"/>
    </Window.InputBindings>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <ToolBarTray Grid.Row="0">
            <!-- File Operations -->
            <ToolBar Header="File">
                <TextBlock Text="Folder:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <TextBox Text="{Binding FolderPath, UpdateSourceTrigger=PropertyChanged}"
                         Width="300" Margin="0,0,5,0"
                         KeyDown="FolderPathTextBox_KeyDown"/>
                <Button Click="BrowseButton_Click" ToolTip="Browse for DICOM folder"
                        Content="&#x1F4C2; Browse" Padding="6,2"/>
                <Button Command="{Binding ReloadCommand}" ToolTip="Reload current folder"
                        Content="&#x1F504; Reload" Padding="6,2"/>
                <Separator/>
                <Button Click="ExportExcelButton_Click" ToolTip="Export ROI data to Excel"
                        Content="&#x1F4CA; Export" Padding="6,2"
                        IsEnabled="{Binding HasFiles}"/>
                <Button Click="SettingsButton_Click" ToolTip="Open folder settings"
                        Content="&#x2699; Settings" Padding="6,2"/>
            </ToolBar>

            <!-- Playback Controls -->
            <ToolBar Header="Playback">
                <Button Command="{Binding PreviousFileCommand}" ToolTip="Previous file"
                        Content="&#x23EE; Prev" Padding="6,2"/>
                <Button Command="{Binding TogglePlaybackCommand}" ToolTip="Play/Pause playback"
                        Content="{Binding IsPlaying, Converter={StaticResource PlayPauseConverter}}"
                        Padding="6,2"/>
                <Button Command="{Binding NextFileCommand}" ToolTip="Next file"
                        Content="Next &#x23ED;" Padding="6,2"/>
                <Separator/>
                <TextBlock Text="FPS:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <Slider Width="100" Minimum="1" Maximum="30"
                        Value="{Binding Fps}"
                        VerticalAlignment="Center"
                        IsSnapToTickEnabled="True" TickFrequency="1"
                        IsEnabled="{Binding HasFiles}"/>
                <TextBlock Text="{Binding Fps}" VerticalAlignment="Center" Margin="5,0,0,0"/>
            </ToolBar>

            <!-- ROI Tools -->
            <ToolBar Header="ROI">
                <TextBlock Text="Shape:" VerticalAlignment="Center" Margin="0,0,3,0"/>
                <ComboBox x:Name="RoiShapeCombo" SelectedIndex="0"
                          SelectionChanged="RoiShapeCombo_SelectionChanged" Width="100"
                          ToolTip="Select ROI drawing shape"
                          IsEnabled="{Binding HasFiles}">
                    <ComboBoxItem Content="Rectangle"/>
                    <ComboBoxItem Content="Ellipse"/>
                    <ComboBoxItem Content="Freeform"/>
                </ComboBox>
                <Button Command="{Binding ClearRoiCommand}" ToolTip="Clear ROI for current group"
                        Content="&#x2716; Clear" Padding="6,2"/>
                <Button Command="{Binding UndoRoiCommand}" ToolTip="Undo last ROI change"
                        Content="&#x21A9; Undo" Padding="6,2"/>
            </ToolBar>
        </ToolBarTray>

        <!-- Info bar -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="5,2">
            <TextBlock Text="{Binding FileInfoText}" VerticalAlignment="Center"
                       FontWeight="SemiBold" Margin="0,0,10,0"/>
            <TextBlock Text="{Binding RoiMeanText}" VerticalAlignment="Center"
                       FontWeight="SemiBold"/>
        </StackPanel>

        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Tree + Filter -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <TreeView Grid.Row="0" Margin="5"
                          ItemsSource="{Binding TreeGroups}"
                          SelectedItemChanged="TreeView_SelectedItemChanged">
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate
                            DataType="{x:Type vm:TreeGroupViewModel}"
                            ItemsSource="{Binding Children}">
                            <TextBlock Text="{Binding Label}"/>
                            <HierarchicalDataTemplate.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:TreeFileViewModel}">
                                    <TextBlock Text="{Binding DisplayName}"/>
                                </DataTemplate>
                            </HierarchicalDataTemplate.ItemTemplate>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
                <TextBox Grid.Row="1" Margin="5"
                         Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"/>
            </Grid>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"/>

            <!-- Right Panel: Image + Tags -->
            <Grid Grid.Column="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="5"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Image Viewer -->
                <Border Grid.Column="0" Margin="5" BorderBrush="Gray"
                        BorderThickness="1" Background="Black">
                    <Canvas x:Name="ImageCanvas" ClipToBounds="True"
                            MouseLeftButtonDown="ImageCanvas_MouseLeftButtonDown"
                            MouseMove="ImageCanvas_MouseMove"
                            MouseLeftButtonUp="ImageCanvas_MouseLeftButtonUp"
                            SizeChanged="ImageCanvas_SizeChanged">
                        <Image x:Name="DicomImageControl"
                               Source="{Binding CurrentImage}"
                               Stretch="Uniform"/>
                    </Canvas>
                </Border>

                <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"/>

                <!-- Tag Panel -->
                <Border Grid.Column="2" Margin="5" BorderBrush="Gray" BorderThickness="1">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="DICOM Tags" FontWeight="Bold" Margin="5"/>
                        <TextBox x:Name="TagSearchBox" Grid.Row="1"
                                 TextChanged="TagSearchBox_TextChanged"
                                 Margin="5,2"/>
                        <ListBox x:Name="TagListBox" Grid.Row="2"
                                 ItemsSource="{Binding DicomTags}"
                                 FontFamily="Consolas" FontSize="11"
                                 SelectionMode="Extended"
                                 PreviewMouseRightButtonDown="TagListBox_PreviewMouseRightButtonDown">
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="Copy Selected Tag(s)"
                                              Click="CopySelectedTags_Click"
                                              InputGestureText="Ctrl+C"/>
                                    <MenuItem Header="Copy All Tags"
                                              Click="CopyAllTags_Click"/>
                                </ContextMenu>
                            </ListBox.ContextMenu>
                        </ListBox>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- Frame Slider -->
        <Grid Grid.Row="3" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="Frame:" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <Slider Grid.Column="1"
                    Minimum="0" Maximum="{Binding MaxFrame}"
                    Value="{Binding CurrentFrame}"
                    VerticalAlignment="Center"
                    IsSnapToTickEnabled="True" TickFrequency="1"
                    ValueChanged="FrameSlider_ValueChanged"
                    IsEnabled="{Binding HasFiles}"/>
            <TextBlock Grid.Column="2" Text="{Binding FrameText}"
                       VerticalAlignment="Center" Margin="5,0,0,0"/>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="4">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}" Foreground="Gray"
                           x:Name="StatusBarText"
                           MouseRightButtonUp="StatusBar_MouseRightButtonUp">
                    <TextBlock.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Copy Status Text" Click="CopyStatusText_Click"
                                      InputGestureText="Ctrl+C" />
                        </ContextMenu>
                    </TextBlock.ContextMenu>
                </TextBlock>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
